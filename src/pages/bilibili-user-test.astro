---
import { fetchBilibiliUserAnimeList, fetchBilibiliUserAllFollowList } from "../utils/bilibili-api";
import { siteConfig } from "../config";

// 测试用户追番API
const userId = siteConfig.anime?.bilibili?.userId || "440430791";
const userAnimeList = await fetchBilibiliUserAnimeList(userId);
const allFollowData = await fetchBilibiliUserAllFollowList(userId);

console.log("用户ID:", userId);
console.log("用户追番数量:", userAnimeList.length);
console.log("所有追番数据:", allFollowData);
---

<html>
<head>
    <title>B站用户追番测试</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .anime-card { 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            padding: 15px; 
            margin: 10px 0; 
            display: flex; 
            gap: 15px;
        }
        .anime-cover { 
            width: 120px; 
            height: 160px; 
            object-fit: cover; 
            border-radius: 4px;
        }
        .anime-info { flex: 1; }
        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-watching { background: #e8f5e8; color: #2d5a2d; }
        .status-completed { background: #e8f0ff; color: #1e3a8a; }
        .status-planned { background: #fff3cd; color: #856404; }
        .stats { 
            background: #f8f9fa; 
            padding: 20px; 
            border-radius: 8px; 
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>B站用户追番测试页面</h1>
    
    <div class="stats">
        <h3>📊 数据统计</h3>
        <p><strong>用户ID:</strong> {userId}</p>
        <p><strong>追番总数:</strong> {userAnimeList.length}</p>
        <p><strong>追番中:</strong> {userAnimeList.filter(anime => anime.status === 'watching').length}</p>
        <p><strong>已完结:</strong> {userAnimeList.filter(anime => anime.status === 'completed').length}</p>
        <p><strong>想看:</strong> {userAnimeList.filter(anime => anime.status === 'planned').length}</p>
    </div>
    
    <h2>🎬 我的追番列表</h2>
    {userAnimeList.length > 0 ? (
        <div>
            {userAnimeList.map(anime => {
                const statusClass = `status-${anime.status}`;
                const progressPercent = anime.totalEpisodes > 0 ? (anime.progress / anime.totalEpisodes) * 100 : 0;
                
                return (
                    <div class="anime-card">
                        <img src={anime.cover} alt={anime.title} class="anime-cover" />
                        <div class="anime-info">
                            <h3 style="margin: 0 0 10px 0; font-size: 18px;">{anime.title}</h3>
                            <p style="margin: 0 0 10px 0; color: #666; font-size: 14px;">{anime.description}</p>
                            
                            <div style="margin: 10px 0;">
                                <span class={`status-badge ${statusClass}`}>
                                    {anime.status === 'watching' ? '▶️ 追番中' : 
                                     anime.status === 'completed' ? '✅ 已完结' : 
                                     '⏰ 想看'}
                                </span>
                                {anime.rating > 0 && (
                                    <span style="margin-left: 10px; color: #ff6b35; font-weight: bold;">
                                        ⭐ {anime.rating}
                                    </span>
                                )}
                            </div>
                            
                            <div style="font-size: 12px; color: #888; margin: 10px 0;">
                                <p style="margin: 2px 0;"><strong>年份:</strong> {anime.year}</p>
                                <p style="margin: 2px 0;"><strong>制作方:</strong> {anime.studio}</p>
                                <p style="margin: 2px 0;"><strong>类型:</strong> {anime.genre.join(", ")}</p>
                                <p style="margin: 2px 0;"><strong>集数:</strong> {anime.episodes}</p>
                                {anime.status === 'watching' && anime.totalEpisodes > 0 && (
                                    <div style="margin: 10px 0;">
                                        <div style="background: #e0e0e0; height: 6px; border-radius: 3px; overflow: hidden;">
                                            <div style="background: #4CAF50; height: 100%; width: {progressPercent}%; transition: width 0.3s;"></div>
                                        </div>
                                        <p style="margin: 5px 0 0 0; font-size: 11px;">
                                            进度: {anime.progress}/{anime.totalEpisodes} ({Math.round(progressPercent)}%)
                                        </p>
                                    </div>
                                )}
                            </div>
                            
                            <a href={anime.link} target="_blank" style="color: #007bff; text-decoration: none; font-size: 12px;">
                                🔗 在B站观看
                            </a>
                        </div>
                    </div>
                );
            })}
        </div>
    ) : (
        <div style="text-align: center; padding: 40px; color: #666;">
            <div style="font-size: 48px; margin-bottom: 20px;">😢</div>
            <h3>暂无追番数据</h3>
            <p>可能的原因：</p>
            <ul style="text-align: left; display: inline-block;">
                <li>用户ID不正确</li>
                <li>用户未登录B站</li>
                <li>用户没有追番记录</li>
                <li>API接口需要用户授权</li>
            </ul>
        </div>
    )}
    
    <div style="margin-top: 40px; padding: 20px; background: #f0f8ff; border-radius: 8px;">
        <h3>🔧 调试信息</h3>
        <p><strong>原始API响应:</strong></p>
        <pre style="background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px;">
{JSON.stringify(allFollowData, null, 2)}
        </pre>
    </div>
</body>
</html>
